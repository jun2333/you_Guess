<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-ui/lib/theme-chalk/index.css"
    />
    <title>RESTful api</title>
  </head>
  <body>
    <div id="app">
      <el-button type="primary" style="margin: 5px" @click="mshow=true"
        >Add</el-button
      >
      <el-table :data="data" v-loading="loading" style="width: 50%">
        <el-table-column type="index"> </el-table-column>
        <el-table-column prop="name" label="名字" width="180">
        </el-table-column>
        <el-table-column prop="age" label="年龄" width="180"> </el-table-column>
        <el-table-column width="280">
          <template slot="header" slot-scope="scope">
            <el-input
              v-model="search"
              size="mini"
              placeholder="输入id搜索"
              @keyup.enter.native="handleSeach"
            />
          </template>
          <template slot-scope="scope">
            <el-button size="mini" @click="handleEdit(scope.row)"
              >Edit</el-button
            >
            <el-button
              type="danger"
              size="mini"
              @click="handleDelete(scope.row.id)"
              >Delete</el-button
            >
          </template>
        </el-table-column>
      </el-table>
      <el-dialog :visible.sync="mshow" :title="title" width="400px">
        <el-form label-position="left" width="50px" size="small">
          <el-form-item label="姓名" label-width="50px">
            <el-input v-model="formData.name"></el-input>
          </el-form-item>
          <el-form-item label="年龄" label-width="50px">
            <el-input v-model="formData.age"></el-input>
          </el-form-item>
        </el-form>
        <el-button @click="mshow = false">取 消</el-button>
        <el-button type="primary" @click="submit">确 定</el-button>
      </el-dialog>
    </div>
    <script>
      axios.interceptors.request.use(
        config => {
          const token = window.localStorage.getItem("token");
          if (token) {
            // 判断是否存在token，如果存在的话，则每个http header都加上token
            // Bearer是JWT的认证头部信息
            config.headers.common["Authorization"] = "Bearer " + token;
          }
          return config;
        },
        err => {
          return Promise.reject(err);
        }
      );

      axios.interceptors.response.use(
        response => {
          const { status, data } = response;
          if (data.code === 401) {
            this.$message({
              type: "warning",
              message: "登录超时，请重新登录!"
            });
            location.href = "/login.html";
            return;
          }
          console.log(status);
          return response;
        },
        err => {
          return Promise.reject(err);
        }
      );
      new Vue({
        el: "#app",
        data() {
          return {
            confirmShow: false,
            loading: false,
            search: "",
            title: "Add",
            formData: {
              name: "",
              age: "",
              id: ""
            },
            mshow: false,
            data: []
          };
        },
        created() {
          this.queryList();
        },
        methods: {
          async queryList() {
            this.loading = true;
            let res = await this.handleData("", "get");
            this.data = res.data;
            this.loading = false;
          },
          async handleSeach() {
            if (!this.search) this.queryList();
            let res = await this.handleData(this.search, "get");
            this.$message({
              type: "success",
              message: "查询成功!"
            });
            if (!res.data[0]) return (this.data = []);
            this.data = res.data;
          },
          handleAdd() {
            this.title = "Add";
            this.formData.name = "";
            this.formData.age = "";
            this.formData.id = "";
          },
          async submit() {
            let { name, age } = this.formData;
            age = Number(age);
            let method, id;
            id = this.formData.id ? this.formData.id : "";
            if (this.title === "Add") method = "post";
            else method = "put";
            await this.handleData(id, method, { name, age });
            this.mshow = false;
            this.queryList();
            this.$message({
              type: "success",
              message: "操作成功!"
            });
          },
          handleEdit(row) {
            this.mshow = true;
            this.title = "Edit";
            this.formData = row;
          },
          handleDelete(id) {
            this.$confirm("此操作将永久删除该文件, 是否继续?", "提示", {
              confirmButtonText: "确定",
              cancelButtonText: "取消",
              type: "warning"
            })
              .then(async () => {
                await this.handleData(id, "delete");
                this.queryList();
                this.$message({
                  type: "success",
                  message: "删除成功!"
                });
              })
              .catch(() => {
                this.$message({
                  type: "info",
                  message: "已取消删除"
                });
              });
          },
          handleData(id = null, method, data = {}) {
            let params;
            if (id) params = `/${id}`;
            else params = "";
            return axios({
              url: `/api/users${params}`,
              method: method,
              data: data
            });
          }
        }
      });
    </script>
  </body>
</html>
